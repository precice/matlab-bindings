name: 'Test Matlab bindings'

on: [push,pull_request]
jobs:
  test-solverdummies:
    name: Test Matlab solverdummmies
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
        - release: latest
        - release: R2022a
        - release: R2021b
        - release: R2021a
        - release: R2020b
        - release: R2020a
    steps:
      - name: Install precice
        uses: precice/setup-precice-action@main
        with:
          precice-version: develop

      - name: Set up Matlab
        uses: matlab-actions/setup-matlab@v1
        with: 
          release: ${{ matrix.release }}

      - name: Check out repository
        uses: actions/checkout@v3

      - name: Run compilation script
        uses: matlab-actions/run-command@v1
        with:
          command: compile_matlab_bindings_for_precice

      - name: Run Solverdummies
        shell: bash
        run: |
          LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libstdc++.so.6 matlab -sd "./solverdummy" -batch "addpath('../'); solverdummy precice-config.xml SolverOne;" & LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libstdc++.so.6 matlab -sd "./solverdummy" -batch "addpath('../'); solverdummy precice-config.xml SolverTwo;"
  
  test-tutorial:
    name: Test matlab Tutorials
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
        - release: latest
        - release: R2022a
        - release: R2021b
        - release: R2021a
        - release: R2020b
        - release: R2020a
    steps:
      - name: Install precice
        uses: precice/setup-precice-action@main
        with:
          precice-version: develop

      - name: Set up Matlab
        uses: matlab-actions/setup-matlab@v1
        with: 
          release: ${{ matrix.release }}

      - name: Check out repository
        uses: actions/checkout@v3

      - name: Run compilation script
        uses: matlab-actions/run-command@v1
        with:
          command: compile_matlab_bindings_for_precice

      - name: Run Tutorials
        run: |
          LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libstdc++.so.6 matlab -sd "./tutorial/implicit" -batch "addpath('../../'); Solver_I;" & LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libstdc++.so.6 matlab -sd "./tutorial/implicit" -batch "addpath('../../'); Solver_U;"

